name: Release SUB Language

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.3)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: sublang-linux
            asset_name: sublang-linux-x64
          - os: macos-latest
            artifact_name: sublang-macos
            asset_name: sublang-macos-x64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup build environment
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y gcc make
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install gcc make
          fi

      - name: Build project
        run: |
          make clean
          make
          chmod +x sublang
          mv sublang ${{ matrix.artifact_name }}

      - name: Test build
        run: |
          ./${{ matrix.artifact_name }} --version || echo "Version flag not implemented"
          echo "Build successful!"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: ${{ matrix.artifact_name }}
          retention-days: 5

  create-release:
    needs: build-and-release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸŽ‰ SUB Language ${{ steps.version.outputs.VERSION }}
          
          ### âœ¨ What's New
          
          #### Ruby Language Support
          - **New Target Language**: SUB now compiles to Ruby! ðŸ”´
          - Natural syntax alignment: SUB's `#end` maps perfectly to Ruby's `end`
          - Full feature support: variables, functions, loops, conditionals
          - Ruby-idiomatic code generation:
            - 2-space indentation (Ruby convention)
            - `elsif` instead of `elif`
            - `puts` for output
            - Proper `end` keyword handling
          
          #### Usage
          ```bash
          ./sublang program.sb ruby
          ruby output.rb
          ```
          
          #### Syntax Examples
          
          | SUB Syntax | Ruby Output |
          |------------|-------------|
          | `#var x = 5` | `x = 5` |
          | `#function foo()` | `def foo` |
          | `#if condition` | `if condition` |
          | `#for i in range(10)` | `(0...10).each do \|i\|` |
          | `#print(x)` | `puts x` |
          | `#end` | `end` |
          
          ### ðŸ“¦ Supported Languages
          
          SUB now compiles to **9 languages**:
          - Python ðŸ
          - JavaScript ðŸ’›
          - Java â˜•
          - C ðŸ”§
          - C++ âš¡
          - Swift ðŸŽ
          - Kotlin ðŸŽ¯
          - Go ðŸ”µ
          - **Ruby ðŸ”´** (NEW!)
          
          ### ðŸ› Bug Fixes
          - Fixed pre-existing bug in Swift codegen (raw newline in string literal)
          
          ### ðŸ“š Documentation
          - Updated README.md with Ruby examples
          - Enhanced MULTILANG_GUIDE.md
          - Expanded LANGUAGE_SPEC.md
          - Added comprehensive contribution guide (table.md)
          
          ### ðŸ§ª Testing
          - 8 new test files for Ruby edge cases
          - All regression tests passing
          - Cross-platform compatibility verified
          
          ### ðŸ™ Contributors
          
          Special thanks to @ul0gic for the excellent Ruby implementation!
          
          ### ðŸ“¥ Installation
          
          Download the appropriate binary for your platform:
          - **Linux (x64)**: `sublang-linux-x64`
          - **macOS (x64)**: `sublang-macos-x64`
          
          > **Note**: Windows support is not available in this release. SUB Language currently supports Linux and macOS only.
          
          Make it executable:
          ```bash
          chmod +x sublang-*-x64
          ./sublang-*-x64 program.sb ruby
          ```
          
          ### ðŸ”— Links
          - [Documentation](https://github.com/subhobhai943/sub-lang/blob/main/README.md)
          - [Contribution Guide](https://github.com/subhobhai943/sub-lang/blob/main/table.md)
          - [Language Specification](https://github.com/subhobhai943/sub-lang/blob/main/LANGUAGE_SPEC.md)
          
          ---
          
          **Full Changelog**: https://github.com/subhobhai943/sub-lang/compare/v1.0.2...v1.0.3
          EOF
          echo "Generated release notes"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: SUB Language ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            artifacts/sublang-linux-x64/*
            artifacts/sublang-macos-x64/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "âœ… Release ${{ steps.version.outputs.VERSION }} created successfully!"
          echo "ðŸ“¦ Artifacts uploaded for Linux and macOS"
          echo "ðŸ”— View release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.VERSION }}"
