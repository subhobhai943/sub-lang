name: Release SUB Language

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.6)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            artifact_name: sublang-linux
            native_name: subc-native-linux
            asset_name: sublang-linux-x64
          - os: macos-latest
            artifact_name: sublang-macos
            native_name: subc-native-macos
            asset_name: sublang-macos-x64
          - os: windows-latest
            artifact_name: sublang-windows.exe
            native_name: subc-native-windows.exe
            asset_name: sublang-windows-x64.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup build environment (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y gcc make
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install gcc make
          fi

      - name: Setup build environment (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build transpiler (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          make clean
          make transpiler
          chmod +x sublang
          mv sublang ${{ matrix.artifact_name }}

      - name: Build transpiler (Windows)
        if: runner.os == 'Windows'
        run: |
          cl /I. sub_multilang.c parser_enhanced.c lexer.c semantic.c codegen.c codegen_multilang.c type_system.c /Fe:${{ matrix.artifact_name }}

      - name: Build native compiler (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          make native
          chmod +x subc-native
          mv subc-native ${{ matrix.native_name }}

      - name: Build native compiler (Windows)
        if: runner.os == 'Windows'
        run: |
          cl /I. sub_native_compiler.c parser_enhanced.c lexer.c semantic.c ir.c codegen_x64.c /Fe:${{ matrix.native_name }}

      - name: Upload transpiler artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}-transpiler
          path: ${{ matrix.artifact_name }}
          retention-days: 5

      - name: Upload native compiler artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}-native
          path: ${{ matrix.native_name }}
          retention-days: 5

  create-release:
    needs: build-and-release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸŽ‰ SUB Language ${{ steps.version.outputs.VERSION }}
          
          ### âš¡ Production-Ready Native Compiler
          
          **Release Date**: December 31, 2025  
          **Type**: Major Feature Release  
          **Focus**: Native x86-64 Compiler + Enhanced Parser
          
          #### âœ¨ What's New
          
          **1. Native x86-64 Compiler** ðŸš€
          - Direct assembly generation for Linux/macOS/Windows
          - Stack-based variable management
          - Full control flow support (if/else, while loops)
          - Arithmetic operations with correct precedence
          - Native binary compilation with zero dependencies
          
          **2. Intermediate Representation (IR)** ðŸ—ï¸
          - Clean separation of parsing and code generation
          - Optimizable IR layer for future enhancements
          - Better architecture for multi-platform support
          
          **3. Enhanced Parser** ðŸ“
          - Fixed operator precedence (PEMDAS)
          - Proper block handling with braces
          - Expression statement support
          - Better error handling
          
          **4. Type System** ðŸ”’
          - Improved type safety
          - Type inference for expressions
          - Target language type mapping
          
          **5. Comprehensive Test Suite** âœ…
          - Universal test validation
          - Multi-language transpilation tests
          - Automated verification pipeline
          
          #### ðŸ› Bug Fixes
          
          - Fixed infinite loops in parser
          - Resolved variable assignment logic errors
          - Corrected operator precedence handling
          - Fixed enum name conflicts
          - Resolved duplicate function definitions
          
          #### ðŸ“¦ What's Included
          
          - **Native Compiler** (`subc-native`) - Compiles to x86-64 machine code
          - **Transpiler** (`sublang`) - Converts to 12+ languages (Python, JS, Java, C++, Rust, Swift, Kotlin, Ruby, etc.)
          - **Full Cross-Platform Support** - Windows, Linux, macOS
          
          #### ðŸš€ Installation
          
          Download the appropriate binaries for your platform:
          - `sublang-linux` / `subc-native-linux` (Linux x86_64)
          - `sublang-macos` / `subc-native-macos` (macOS x86_64)
          - `sublang-windows.exe` / `subc-native-windows.exe` (Windows x64)
          
          #### ðŸ“ Usage
          
          **Native Compilation:**
          ```bash
          ./subc-native program.sb myapp
          ./myapp
          ```
          
          **Transpilation:**
          ```bash
          ./sublang program.sb python
          python3 output.py
          ```
          
          #### ðŸ™ Contributors
          
          Special thanks to [@Ratkiller446](https://github.com/Ratkiller446) for the amazing contribution in PR #5!
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v1.0.5...${{ steps.version.outputs.VERSION }}
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: SUB Language ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            artifacts/sublang-linux-x64-transpiler/*
            artifacts/sublang-linux-x64-native/*
            artifacts/sublang-macos-x64-transpiler/*
            artifacts/sublang-macos-x64-native/*
            artifacts/sublang-windows-x64.exe-transpiler/*
            artifacts/sublang-windows-x64.exe-native/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "âœ… Release ${{ steps.version.outputs.VERSION }} created successfully!"
          echo "ðŸ“¦ Artifacts uploaded for Windows, Linux, and macOS"
          echo "ðŸ”— View release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.VERSION }}"
