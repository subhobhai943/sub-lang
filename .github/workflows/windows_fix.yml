name: Windows Build Fix

on:
  push:
    branches:
      - main
      - windows-fix
  workflow_dispatch:
    inputs:
      test_windows:
        description: 'Test Windows build with MinGW'
        required: false
        type: boolean
        default: true

jobs:
  build-windows:
    name: Build on Windows (MinGW)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install MinGW-w64
        run: |
          choco install mingw --params "/threads:posix /exception:seh" -y
          echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify MinGW installation
        run: |
          gcc --version
          make --version
          echo "MINGW_ROOT=$env:MINGW_ROOT"
          echo "PATH=$env:PATH"

      - name: Build with Makefile
        run: |
          make clean
          make all

      - name: Verify build artifacts
        run: |
          if (Test-Path "sublang.exe") { Write-Host "✅ sublang.exe found" } else { Write-Host "❌ sublang.exe NOT found"; exit 1 }
          if (Test-Path "subc-native.exe") { Write-Host "✅ subc-native.exe found" } else { Write-Host "❌ subc-native.exe NOT found"; exit 1 }

      - name: Quick test transpiler
        run: |
          echo "Testing transpiler..."
          .\sublang.exe example.sb python
          if (Test-Path "output.py") { Write-Host "✅ Transpilation successful" } else { Write-Host "❌ output.py NOT created"; exit 1 }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: |
            sublang.exe
            subc-native.exe
          retention-days: 7

  build-unix:
    name: Build on Unix-like (Linux/macOS)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup build dependencies
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y gcc make
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install gcc make || true
          fi

      - name: Build with Makefile
        run: |
          make clean
          make all

      - name: Verify build artifacts
        run: |
          if [ -f "sublang" ] || [ -f "sublang.exe" ]; then echo "✅ Transpiler built"; else exit 1; fi
          if [ -f "subc-native" ] || [ -f "subc-native.exe" ]; then echo "✅ Native compiler built"; else exit 1; fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-binaries
          path: |
            sublang
            subc-native
          retention-days: 7
